{% extends "base.html" %}
{% from "components/nba_components.html" import card_container, badge %}

{% block title %}Administración de Ingesta - Dateados{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-black text-gray-900 dark:text-gray-100 tracking-tight">Panel de Control de Datos</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Sincroniza la base de datos con los últimos resultados oficiales.</p>
        </div>
        <div id="status-badge">
            {% if status and status.status == 'running' %}
                {{ badge('EJECUTANDO', 'info', class='animate-pulse') }}
            {% elif status and status.status == 'completed' %}
                {{ badge('COMPLETADO', 'success') }}
            {% elif status and status.status == 'failed' %}
                {{ badge('FALLIDO', 'error') }}
            {% else %}
                {{ badge('INACTIVO', 'default') }}
            {% endif %}
        </div>
    </div>

    <!-- Main Control Card -->
    {% call card_container(title="Ingesta Incremental") %}
        <div class="p-8 space-y-6">
            <div class="flex flex-col items-center text-center space-y-4">
                <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-full">
                    <svg class="w-12 h-12 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Actualizar Estadísticas</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 max-w-sm">
                        Busca y descarga los partidos jugados recientemente que aún no están en Dateados. Este proceso es seguro y consume pocos recursos.
                    </p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="start-ingest-btn" 
                            onclick="startIngestion(false)"
                            {% if status and status.status == 'running' %}disabled{% endif %}
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-blue-500/20 active:scale-95">
                        Iniciar Sincronización
                    </button>
                    <button id="reset-ingest-btn" 
                            onclick="startIngestion(true)"
                            {% if status and status.status == 'running' %}disabled{% endif %}
                            class="px-6 py-3 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-xl font-bold transition-all active:scale-95">
                        Reiniciar desde cero
                    </button>
                </div>
            </div>

            <!-- Progress Section (Hidden by default unless running) -->
            <div id="progress-section" class="{% if not status or status.status != 'running' %}hidden{% endif %} space-y-4 border-t border-gray-100 dark:border-gray-700 pt-8">
                <div class="flex justify-between items-end">
                    <div class="space-y-1">
                        <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest">Progreso actual</span>
                        <p id="progress-message" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            {{ status.message if status else 'Preparando...' }}
                        </p>
                    </div>
                    <span id="progress-percent" class="text-2xl font-black text-gray-900 dark:text-gray-100">
                        {{ status.progress if status else '0' }}%
                    </span>
                </div>
                
                <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-3 overflow-hidden shadow-inner">
                    <div id="progress-bar" 
                         class="bg-blue-600 h-full transition-all duration-500 rounded-full shadow-lg shadow-blue-500/50" 
                         style="width: {{ status.progress if status else '0' }}%">
                    </div>
                </div>

                <div class="bg-black rounded-xl border border-gray-800 shadow-2xl overflow-hidden">
                    <div id="log-console" class="text-[11px] font-mono p-6 h-80 overflow-y-auto custom-scrollbar bg-black text-gray-300 leading-relaxed">
                        <p class="text-gray-600">// Terminal lista. Esperando eventos...</p>
                    </div>
                </div>
            </div>
        </div>
    {% endcall %}
</div>

<script>
    let pollInterval;
    let lastLogId = 0;

    function startIngestion(clean = false) {
        const btn = document.getElementById('start-ingest-btn');
        const resetBtn = document.getElementById('reset-ingest-btn');
        btn.disabled = true;
        resetBtn.disabled = true;
        btn.innerText = clean ? 'Reiniciando...' : 'Iniciando...';
        
        fetch(`/admin/ingest/run?clean=${clean}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('progress-section').classList.remove('hidden');
                    updateBadge('running');
                    // Limpiar consola al iniciar nueva
                    document.getElementById('log-console').innerHTML = `<p class="text-blue-400 font-bold">>> Iniciando ${clean ? 'reinicio' : 'nueva sesión'} de ingesta...</p>`;
                    if (clean) lastLogId = 0;
                    startPolling();
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    resetBtn.disabled = false;
                    btn.innerText = 'Iniciar Sincronización';
                }
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                resetBtn.disabled = false;
                btn.innerText = 'Iniciar Sincronización';
            });
    }

    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        // Polling más frecuente para logs (2s)
        pollInterval = setInterval(() => {
            updateStatus();
            updateLogs();
        }, 2000);
    }

    function updateLogs() {
        fetch('/admin/ingest/logs?limit=50')
            .then(res => res.json())
            .then(logs => {
                const console = document.getElementById('log-console');
                let hasNew = false;

                logs.forEach(log => {
                    if (log.id > lastLogId) {
                        const p = document.createElement('p');
                        const ts = new Date(log.timestamp).toLocaleTimeString();
                        
                        let levelClass = 'text-gray-500';
                        if (log.level === 'ERROR') levelClass = 'text-red-500 font-bold';
                        if (log.level === 'WARNING') levelClass = 'text-amber-500';
                        if (log.level === 'INFO') levelClass = 'text-green-400';

                        p.innerHTML = `<span class="text-gray-600">[${ts}]</span> <span class="${levelClass}">${log.level.padEnd(7)}</span> <span class="text-blue-400">${log.module}:</span> ${log.message}`;
                        console.appendChild(p);
                        lastLogId = log.id;
                        hasNew = true;
                    }
                });

                if (hasNew) {
                    console.scrollTop = console.scrollHeight;
                }
            });
    }

    function updateStatus() {
        fetch('/admin/ingest/status')
            .then(res => res.json())
            .then(data => {
                const bar = document.getElementById('progress-bar');
                const percent = document.getElementById('progress-percent');
                const message = document.getElementById('progress-message');
                const btn = document.getElementById('start-ingest-btn');

                bar.style.width = data.progress + '%';
                percent.innerText = data.progress + '%';
                message.innerText = data.message;

                if (data.status !== 'running') {
                    // No detenemos el polling de logs inmediatamente para ver el mensaje final
                    btn.disabled = false;
                    document.getElementById('reset-ingest-btn').disabled = false;
                    btn.innerText = 'Iniciar Sincronización';
                    updateBadge(data.status);
                    
                    if (data.status === 'completed') {
                        bar.classList.replace('bg-blue-600', 'bg-green-500');
                        clearInterval(pollInterval);
                    } else if (data.status === 'failed') {
                        bar.classList.replace('bg-blue-600', 'bg-red-500');
                        clearInterval(pollInterval);
                    }
                }
            });
    }

    function updateBadge(status) {
        const container = document.getElementById('status-badge');
        let color = 'default';
        let text = 'INACTIVO';
        let extra = '';

        if (status === 'running') { color = 'info'; text = 'EJECUTANDO'; extra = 'animate-pulse'; }
        else if (status === 'completed') { color = 'success'; text = 'COMPLETADO'; }
        else if (status === 'failed') { color = 'error'; text = 'FALLIDO'; }

        container.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-tight bg-${getBadgeColor(color)} ${extra}">${text}</span>`;
    }

    function getBadgeColor(type) {
        const colors = {
            'default': 'gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300',
            'success': 'green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300',
            'error': 'red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300',
            'info': 'blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300'
        };
        return colors[type] || colors.default;
    }

    // Auto-start polling if already running
    {% if status and status.status == 'running' %}
        startPolling();
    {% endif %}
</script>
{% endblock %}
