{% extends "base.html" %}
{% from "components/nba_components.html" import badge, stats_table_header, page_header, window_selector, stats_summary_bar, pill_tabs, empty_state, pagination %}

{% block title %}Rachas - Dateados{% endblock %}

{% block content %}
<div class="space-y-6">
    {% call page_header("Monitor de Rachas NBA", "Seguimiento de hitos estadisticos consecutivos en curso y records historicos.") %}
        {{ window_selector([
            {'id': 'regular', 'label': 'Regular'},
            {'id': 'playoffs', 'label': 'Playoffs'},
            {'id': 'nba_cup', 'label': 'NBA Cup'}
        ], current=comp, base_url='?type=' ~ streak_type_filter, param_name='comp') }}
    {% endcall %}

    {{ stats_summary_bar([
        {'label': 'Hitos Historicos', 'value': total_historical|default(0), 'color': 'indigo', 'icon': 'M5 3v18l15-9L5 3z'},
        {'label': 'En Curso', 'value': total_active|default(0), 'color': 'green', 'icon': 'M13 10V3L4 14h7v7l9-11h-7z'},
        {'label': 'Rotas (7d)', 'value': total_broken|default(0), 'color': 'red', 'icon': 'M6 18L18 6M6 6l12 12'}
    ], columns=3) }}

    <div class="nba-pill-container">
        <nav class="nba-pill-flex streak-type-nav">
            <a href="?comp={{ comp }}&type=all"
               class="nba-pill-tab {% if streak_type_filter == 'all' %}nba-pill-active{% else %}nba-pill-inactive{% endif %}">
                Todos
            </a>
            {% for st in streak_types %}
            <a href="?comp={{ comp }}&type={{ st }}"
               class="nba-pill-tab {% if streak_type_filter == st %}nba-pill-active{% else %}nba-pill-inactive{% endif %}">
                {{ streak_names.get(st, st) }}
            </a>
            {% endfor %}
        </nav>
    </div>

    <div class="nba-card overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 dark:border-white/5 flex items-center justify-between bg-slate-50/50 dark:bg-black/20 backdrop-blur-sm">
            <div>
                <h2 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-widest font-display">Analisis Unificado de Rachas</h2>
                <p class="text-[9px] text-zinc-500 dark:text-zinc-400 font-bold uppercase mt-0.5">Rendimiento actual comparado con records historicos de la liga</p>
            </div>
        </div>
        
        <div class="table-container">
            <table class="min-w-full border-separate border-spacing-0">
                {{ stats_table_header([
                    {'label': 'Jugador', 'class': 'text-left px-6'},
                    {'label': 'Hito', 'class': 'text-left'},
                    {'label': 'Longitud'},
                    {'label': 'Contexto', 'class': 'text-left px-6'}
                ]) }}
                <tbody class="divide-y divide-slate-100 dark:divide-white/5">
                    {% for s in active_streaks | sort(attribute='progress', reverse=True) %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors group cursor-pointer" onclick="window.location='/players/{{ s.player_id }}'">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-slate-900 dark:text-white group-hover:text-orange-500 font-bold transition-colors">
                                {{ s.player_name }}
                            </span>
                        </td>
                        <td class="px-2 py-4 whitespace-nowrap text-[10px] font-black text-zinc-400 dark:text-zinc-500 uppercase tracking-widest">
                            {{ streak_names.get(s.streak_type, s.streak_type) }}
                        </td>
                        <td class="px-4 py-4 text-center">
                            <span class="text-xl font-display font-black {% if s.is_historical %}text-indigo-600 dark:text-indigo-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                                {{ s.length }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-500 dark:text-zinc-400 uppercase tracking-tighter">
                                    Record: {{ s.all_time_length }} ({{ s.all_time_holder }})
                                </span>
                                <div class="mt-1.5 h-1 w-32 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden shadow-inner">
                                    <div style="width:{{ s.progress if s.progress <= 100 else 100 }}%" class="h-full bg-green-500 transition-all duration-1000 ease-out"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                    {% for s in broken_streaks %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors group cursor-pointer opacity-70 hover:opacity-100" onclick="window.location='/players/{{ s.player_id }}'">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-slate-900 dark:text-white group-hover:text-orange-500 font-bold transition-colors">
                                {{ s.player_name }}
                            </span>
                        </td>
                        <td class="px-2 py-4 whitespace-nowrap text-[10px] font-black text-zinc-400 dark:text-zinc-500 uppercase tracking-widest">
                            {{ streak_names.get(s.streak_type, s.streak_type) }}
                        </td>
                        <td class="px-4 py-4 text-center">
                            <span class="text-xl font-display font-black {% if s.is_historical %}text-indigo-600 dark:text-indigo-400{% else %}text-red-500 dark:text-red-400{% endif %}">
                                {{ s.length }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             <span class="text-[10px] font-black text-red-500/80 dark:text-red-400/80 uppercase tracking-tighter">
                                Finalizada: {{ s.ended_at }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not active_streaks and not broken_streaks %}
            {{ empty_state("No hay rachas que coincidan con este filtro.") }}
            {% endif %}
        </div>

        {{ pagination(page, total_pages, '/streaks', {
            'comp': comp,
            'type': streak_type_filter
        }) if total_pages > 1 }}
    </div>
</div>
{% endblock %}
